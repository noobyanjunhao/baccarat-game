{% extends 'game/base.html' %}
{% load static %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <h2>Baccarat Game</h2>
            <p>Round: {{ game.round_number }} | Cards used: {{ game.cards_used }} / 416</p>
            <p>Your bet: {{ game.bet_on|title }} for ${{ game.buy_in }}</p>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-md-6">
            <h3>Player: <span id="player-score">{{ game.player_score }}</span></h3>
            <div class="card-container" id="player-cards">
                {% for card in game.player_cards %}
                <div class="card-wrapper" data-index="{{ forloop.counter0 }}" data-type="player">
                    {% if card.flipped %}
                    <img src="{% static 'images/cards/'|add:card.suit|add:'_'|add:card.value|add:'.png' %}" alt="{{ card.value }} of {{ card.suit }}">
                    {% else %}
                    <img src="{% static 'images/cards/back.png' %}" alt="Card back" class="card-back">
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="col-md-6">
            <h3>Banker: <span id="banker-score">{{ game.banker_score }}</span></h3>
            <div class="card-container" id="banker-cards">
                {% for card in game.banker_cards %}
                <div class="card-wrapper" data-index="{{ forloop.counter0 }}" data-type="banker">
                    {% if card.flipped %}
                    <img src="{% static 'images/cards/'|add:card.suit|add:'_'|add:card.value|add:'.png' %}" alt="{{ card.value }} of {{ card.suit }}">
                    {% else %}
                    <img src="{% static 'images/cards/back.png' %}" alt="Card back" class="card-back">
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    {% if game_complete %}
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="alert alert-info">
                <h3>Game Result: {{ game.result|title }}</h3>
                <p>Your payout: ${{ game.payout }}</p>
                <p>Net winnings: ${{ game.total_winnings }}</p>
                
                <div class="mt-3">
                    <a href="{% url 'continue_game' game.id %}" class="btn btn-success">Continue with Same Shoe</a>
                    <a href="{% url 'new_game' %}" class="btn btn-primary">Start New Game</a>
                    <a href="{% url 'history' %}" class="btn btn-secondary">View History</a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const cardBacks = document.querySelectorAll('.card-back');
        
        cardBacks.forEach(card => {
            const wrapper = card.parentElement;
            wrapper.addEventListener('click', function() {
                const cardIndex = this.dataset.index;
                const cardType = this.dataset.type;
                
                flipCard(cardIndex, cardType);
            });
        });
        
        function flipCard(index, type) {
            fetch(`/game/{{ game.id }}/flip-card/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    card_index: index,
                    card_type: type
                })
            })
            .then(response => response.json())
            .then(data => {
                updateCards('player', data.player_cards);
                updateCards('banker', data.banker_cards);
                
                document.getElementById('player-score').textContent = data.player_score;
                document.getElementById('banker-score').textContent = data.banker_score;
                
                if (data.result) {
                    showResult(data.result, data.payout);
                }
            });
        }
        
        function updateCards(type, cards) {
            const container = document.getElementById(`${type}-cards`);
            container.innerHTML = '';
            
            cards.forEach((card, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'card-wrapper';
                wrapper.dataset.index = index;
                wrapper.dataset.type = type;
                
                const img = document.createElement('img');
                if (card.flipped) {
                    img.src = `/static/images/cards/${card.suit}_${card.value}.png`;
                    img.alt = `${card.value} of ${card.suit}`;
                } else {
                    img.src = '/static/images/cards/back.png';
                    img.alt = 'Card back';
                    img.className = 'card-back';
                    wrapper.addEventListener('click', function() {
                        flipCard(index, type);
                    });
                }
                
                wrapper.appendChild(img);
                container.appendChild(wrapper);
            });
        }
        
        function showResult(result, payout) {
            // Reload the page to show the game result and continue button
            location.reload();
        }
    });
</script>
{% endblock %}